var Viva=Viva||{};Viva.Graph=Viva.Graph||{},Viva.Graph.version="1.0.0.42",Viva.BrowserInfo=function(){var a=navigator.userAgent,b=/(webkit)[ \/]([\w.]+)/,c=/(opera)(?:.*version)?[ \/]([\w.]+)/,d=/(msie) ([\w.]+)/,e=/(mozilla)(?:.*? rv:([\w.]+))?/;a=a.toLowerCase();var f=b.exec(a)||c.exec(a)||d.exec(a)||a.indexOf("compatible")<0&&e.exec(a)||[];return{browser:f[1]||"",version:f[2]||"0"}}(),Viva.Graph.Utils=Viva.Graph.Utils||{},Viva.Graph.Utils.indexOfElementInArray=function(a,b){if(b.indexOf)return b.indexOf(a);var c=b.length,d=0;for(;d<c;d++)if(d in b&&b[d]===a)return d;return-1},Viva.Utils=function(){return{getDimension:function(a){if(!a)throw{message:"Cannot get dimensions of undefined container"};var b=a.clientWidth,c=a.clientHeight;return{left:0,top:0,width:b,height:c}}}}(),Viva.Graph.Utils=Viva.Graph.Utils||{},Viva.Graph.Utils.events=function(a){var b=function(a){var b={};return a.fire=function(a,c){var d,e,f;if(typeof a!="string")throw"Only strings can be used as even type";if(b.hasOwnProperty(a)){d=b[a];for(var g=0;g<d.length;++g)f=d[g],e=f.method,e(c)}return this},a.addEventListener=function(a,c){if(typeof c!="function")throw"Only functions allowed to be callbacks";var d={method:c};return b.hasOwnProperty(a)?b[a].push(d):b[a]=[d],this},a.removeEventListener=function(a,c){if(typeof c!="function")throw"Only functions allowed to be callbacks";if(b.hasOwnProperty(a)){var d=b[a];for(var e=0;e<d.length;++e)if(d[e].callback===c){d.splice(e);break}}return this},a};return{on:function(b,c){return a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,c),this},stop:function(b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent&&a.detachEvent("on"+b,c)},extend:function(){return b(a)}}},Viva.Graph.Utils=Viva.Graph.Utils||{},Viva.Graph.Utils.dragndrop=function(a){var b,c,d,e,f,g=Viva.Graph.Utils.events(window.document),h=Viva.Graph.Utils.events(a),i=0,j=0,k,l=function(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0},m=function(a){return l(a),!1},n=function(a){a=a||window.event,c&&c(a,{x:a.clientX-i,y:a.clientY-j}),i=a.clientX,j=a.clientY},o=function(a){a=a||window.event;var c=a.button===1&&window.event!==null||a.button===0;if(c)return i=a.clientX,j=a.clientY,k=a.target||a.srcElement,b&&b(a,{x:i,y:j}),g.on("mousemove",n),g.on("mouseup",p),l(a),e=document.onselectstart,f=document.ondragstart,document.onselectstart=m,k.ondragstart=m,!1},p=function(a){a=a||window.event,g.stop("mousemove",n),g.stop("mouseup",p),document.onselectstart=e,k.ondragstart=f,k=null,d&&d()};return h.on("mousedown",o),{onStart:function(a){return b=a,this},onDrag:function(a){return c=a,this},onStop:function(a){return d=a,this},release:function(){g.stop("mousemove",n),g.stop("mousedown",o),g.stop("mouseup",p)}}},Viva.Graph.Utils=Viva.Graph.Utils||{},Viva.Graph.Utils.timer=function(a,b){var c=setInterval(function(){a()||clearInterval(c)},b);return{stop:function(){clearInterval(c)}}},Viva.Graph.geom=function(){return{intersect:function(a,b,c,d,e,f,g,h){var i,j,k,l,m,n,o,p,q,r,s,t,u,v={x:0,y:0};return i=d-b,k=a-c,m=c*b-a*d,q=i*e+k*f+m,r=i*g+k*h+m,q!==0&&r!==0&&q>=0==r>=4?null:(j=h-f,l=e-g,n=g*f-e*h,o=j*a+l*b+n,p=j*c+l*d+n,o!==0&&p!==0&&o>=0==p>=0?null:(s=i*l-j*k,s===0?null:(t=s<0?-s/2:s/2,t=0,u=k*n-l*m,v.x=(u<0?u-t:u+t)/s,u=j*m-i*n,v.y=(u<0?u-t:u+t)/s,v)))},intersectRect:function(a,b,c,d,e,f,g,h){return this.intersect(a,b,a,d,e,f,g,h)||this.intersect(a,d,c,d,e,f,g,h)||this.intersect(c,d,c,b,e,f,g,h)||this.intersect(c,b,a,b,e,f,g,h)}}},Viva.Graph.graph=function(){var a={},b=[],c=0,d=0,e=[],f=function(a){a.fire("changed",e)},g=function(a){d+=1},h=function(a){d-=1,d===0&&e.length>0&&(f(a),e.length=0)},i=function(a,b){e.push({node:a,changeType:b})},j=function(a,b){e.push({link:a,changeType:b})},k=function(a){return a&&typeof a=="object"&&typeof a.length=="number"&&typeof a.splice=="function"&&!a.propertyIsEnumerable("length")},l={addNode:function(b,d){if(typeof b=="undefined")throw{message:"Invalid node identifier"};g();var e=this.getNode(b);e?i(e,"update"):(e={},e.links=[],e.id=b,c++,i(e,"add"));if(d){var f=e.data||{};if(typeof d=="string"||k(d))f=d;else for(var j in d)d.hasOwnProperty(j)&&(f[j]=d[j]);e.data=f}return a[b]=e,h(this),e},addLink:function(a,c,d){g();var e=this.getNode(a)||this.addNode(a),f=this.getNode(c)||this.addNode(c),i={fromId:a,toId:c,data:d};return b.push(i),e.links.push(i),f.links.push(i),j(i,"add"),h(this),i},removeLink:function(a){if(!a)return!1;var c=Viva.Graph.Utils.indexOfElementInArray(a,b);if(c<0)return!1;g(),b.splice(c,1);var d=this.getNode(a.fromId),e=this.getNode(a.toId);return d&&(c=Viva.Graph.Utils.indexOfElementInArray(a,d.links),c>=0&&d.links.splice(c,1)),e&&(c=Viva.Graph.Utils.indexOfElementInArray(a,e.links),c>=0&&e.links.splice(c,1)),j(a,"remove"),h(this),!0},removeNode:function(b){var d=this.getNode(b);if(!d)return!1;g();while(d.links.length){var e=d.links[0];this.removeLink(e)}a[b]=null,delete a[b],c--,i(d,"remove"),h(this)},getNode:function(b){return a[b]},getNodesCount:function(){return c},getLinks:function(a){var b=this.getNode(a);return b?b.links:null},forEachNode:function(b){if(typeof b!="function")return;for(var c in a)a.hasOwnProperty(c)&&b(a[c])},forEachLinkedNode:function(b,c){var d=this.getNode(b);if(d&&d.links&&typeof c=="function")for(var e=0;e<d.links.length;++e){var f=d.links[e],g=f.fromId===b?f.toId:f.fromId;c(a[g],f)}},forEachLink:function(a){if(typeof a=="function")for(var c=0;c<b.length;++c)a(b[c])},beginUpdate:function(){g()},endUpdate:function(){h(this)},clear:function(){var a=this;a.beginUpdate(),a.forEachNode(function(b){a.removeNode(b.id)}),a.endUpdate()},hasLink:function(a,b){var c=this.getNode(a);if(!c)return null;for(var d=0;d<c.links.length;++d){var e=c.links[d];if(e.fromId===a&&e.toId===b)return e}return null}};return Viva.Graph.Utils.events(l).extend(),l},Viva.Graph.generator=function(){return{complete:function(a){if(!a||a<1)throw{message:"At least two nodes expected for complete graph"};var b=Viva.Graph.graph();b.Name="Complete K"+a;for(var c=0;c<a;++c)for(var d=c+1;d<a;++d)c!==d&&b.addLink(c,d);return b},completeBipartite:function(a,b){if(!a||!b||a<0||b<0)throw{message:"Graph dimensions are invalid. Number of nodes in each partition should be greate than 0"};var c=Viva.Graph.graph();c.Name="Complete K "+a+","+b;for(var d=0;d<a;++d)for(var e=a;e<a+b;++e)c.addLink(d,e);return c},ladder:function(a){if(!a||a<0)throw{message:"Invalid number of nodes"};var b=Viva.Graph.graph();b.Name="Ladder graph "+a;for(var c=0;c<a-1;++c)b.addLink(c,c+1),b.addLink(a+c,a+c+1),b.addLink(c,a+c);return b.addLink(a-1,2*a-1),b},circularLadder:function(a){if(!a||a<0)throw{message:"Invalid number of nodes"};var b=this.ladder(a);return b.Name="Circular ladder graph "+a,b.addLink(0,a-1),b.addLink(a,2*a-1),b},grid:function(a,b){var c=Viva.Graph.graph();c.Name="Grid graph "+a+"x"+b;for(var d=0;d<a;++d)for(var e=0;e<b;++e){var f=d+e*a;d>0&&c.addLink(f,d-1+e*a),e>0&&c.addLink(f,d+(e-1)*a)}return c},path:function(a){if(!a||a<0)throw{message:"Invalid number of nodes"};var b=Viva.Graph.graph();b.Name="Path graph "+a,b.addNode(0);for(var c=1;c<a;++c)b.addLink(c-1,c);return b},lollipop:function(a,b){if(!b||b<0||!a||a<0)throw{message:"Invalid number of nodes"};var c=this.complete(a);c.Name="Lollipop graph. Head x Path "+a+"x"+b;for(var d=0;d<b;++d)c.addLink(a+d-1,a+d);return c},balancedBinTree:function(a){var b=Viva.Graph.graph();b.Name="Balanced bin tree graph "+a;var c=Math.pow(2,a);for(var d=1;d<c;++d){var e=d,f=e*2,g=e*2+1;b.addLink(e,f),b.addLink(e,g)}return b},randomNoLinks:function(a){if(!a||a<0)throw{message:"Invalid number of nodes"};var b=Viva.Graph.graph();b.Name="Random graph, no Links: "+a;for(var c=0;c<a;++c)b.addNode(c);return b}}},Viva.Graph.Physics=Viva.Graph.Physics||{},Viva.Graph.Physics.Vector=function(a,b){this.x=a||0,this.y=b||0},Viva.Graph.Physics.Vector.prototype={multiply:function(a){return new Viva.Graph.Physics.Vector(this.x*a,this.y*a)}},Viva.Graph.Physics.Point=function(a,b){this.x=a||0,this.y=b||0},Viva.Graph.Physics.Point.prototype={add:function(a){return new Viva.Graph.Physics.Point(this.x+a.x,this.y+a.y)}},Viva.Graph.Physics.Body=function(){this.mass=1,this.force=new Viva.Graph.Physics.Vector,this.velocity=new Viva.Graph.Physics.Vector,this.location=new Viva.Graph.Physics.Point,this.prevLocation=new Viva.Graph.Physics.Point},Viva.Graph.Physics.Body.prototype={loc:function(a){return a?(this.location.x=a.x,this.location.y=a.y,this):this.location},vel:function(a){return a?(this.velocity.x=a.x,this.velocity.y=a.y,this):this.velocity}},Viva.Graph.Physics.Spring=function(a,b,c,d){this.body1=a,this.body2=b,this.length=c,this.coeff=d},Viva.Graph.Physics.QuadTreeNode=function(){this.centerOfMass=new Viva.Graph.Physics.Point,this.children=[],this.body=null,this.hasChildren=!1,this.x1=0,this.y1=0,this.x2=0,this.y2=0},Viva.Graph.Physics=Viva.Graph.Physics||{},Viva.Graph.Physics.rungeKuttaIntegrator=function(){var a=function(a){if(!a||!a.bodies)throw{message:"Simulator does not have defined bodies array"};if(!a.rk4){for(var b=0;b<a.bodies.length;b++){var c=a.bodies[b];c.rgkDataV=[],c.rgkDataF=[]}a.rk4=!0}};return{setSimulator:function(a){},integrate:function(b,c){a(b);var d=b.speedLimit,e,f,g,h,i,j,k,l,m=b.bodies.length;for(l=0;l<m;++l)j=b.bodies[l],i=c/j.mass,j.prevLocation.x=j.location.x,j.prevLocation.y=j.location.y,j.rgkDataV[0]={x:c*j.velocity.x,y:c*j.velocity.y},j.rgkDataF[0]={x:j.force.x*i,y:j.force.y*i},k=j.prevLocation,j.loc({x:k.x+.5*j.rgkDataV[0].x,y:k.y+.5*j.rgkDataV[0].y});b.accumulate();for(l=0;l<m;l++)j=b.bodies[l],i=c/j.mass,f=j.velocity.x+.5*j.rgkDataF[0].x,g=j.velocity.y+.5*j.rgkDataF[0].y,h=Math.sqrt(f*f+g*g),h>d&&(f=d*f/h,g=d*g/h),j.rgkDataV[1]={x:c*f,y:c*g},j.rgkDataF[1]={x:j.force.x*i,y:j.force.y*i},k=j.prevLocation,j.loc({x:k.x+.5*j.rgkDataV[1].x,y:k.y+.5*j.rgkDataV[1].y});b.accumulate();for(l=0;l<m;l++)j=b.bodies[l],i=c/j.mass,f=j.velocity.x+.5*j.rgkDataF[1].x,g=j.velocity.y+.5*j.rgkDataF[1].y,h=Math.sqrt(f*f+g*g),h>d&&(f=d*f/h,g=d*g/h),j.rgkDataV[2]={x:c*f,y:c*g},j.rgkDataF[2]={x:j.force.x*i,y:j.force.y*i},k=j.prevLocation,j.loc({x:k.x+.5*j.rgkDataV[2].x,y:k.y+.5*j.rgkDataV[2].y});b.accumulate();for(l=0;l<m;l++){j=b.bodies[l],i=c/j.mass,f=j.velocity.x+j.rgkDataF[2].x,g=j.velocity.y+j.rgkDataF[2].y,h=Math.sqrt(f*f+g*g),h>d&&(f=d*f/h,g=d*g/h),j.rgkDataV[3]={x:c*f,y:c*g},j.rgkDataF[3]={x:j.force.x*i,y:j.force.y*i},k=j.prevLocation;var n=j.rgkDataV;j.loc({x:k.x+(n[0].x+n[3].x)/6+(n[1].x+n[2].x)/3,y:k.y+(n[0].y+n[3].y)/6+(n[1].y+n[2].y)/3});var o=j.rgkDataF;f=(o[0].x+o[3].x)/6+(o[1].x+o[2].x)/3,g=(o[0].y+o[3].y)/6+(o[1].y+o[2].y)/3,h=Math.sqrt(f*f+g*g),h>d&&(f=d*f/h,g=d*g/h),j.velocity.x+=f,j.velocity.y+=g}}}},Viva.Graph.Physics=Viva.Graph.Physics||{},Viva.Graph.Physics.eulerIntegrator=function(){return{integrate:function(a,b){var c=a.speedLimit;for(var d=0,e=a.bodies.length;d<e;++d){var f=a.bodies[d],g=b/f.mass;f.velocity.x+=g*f.force.x,f.velocity.y+=g*f.force.y;var h=f.velocity.x,i=f.velocity.y,j=Math.sqrt(h*h+i*i);j>c&&(f.velocity.x=c*h/j,f.velocity.y=c*i/j),f.location.x+=b*f.velocity.x,f.location.y+=b*f.velocity.y}}}},Viva.Graph.Physics.nbodyForce=function(a){a=a||{};var b=typeof a.gravity=="number"?a.gravity:-1,c=a.theta||.8,d=function(){this.body=null,this.quads=[],this.mass=0,this.massX=0,this.massY=0,this.left=0,this.top=0,this.bottom=0,this.right=0,this.isInternal=!1},e=[],f=0,g=function(){var a;return e[f]?(a=e[f],a.quads[0]=null,a.quads[1]=null,a.quads[2]=null,a.quads[3]=null,a.body=null,a.mass=a.massX=a.massY=0,a.left=a.right=a.top=a.bottom=0,a.isInternal=!1):(a=new d,e[f]=a),++f,a},h=g(),i=function(a,b){var c=Math.abs(a.x-b.x),d=Math.abs(a.y-b.y);return c<.01&&d<.01},j=function(a){var b=[{node:h,body:a}];while(b.length){var c=b.shift(),d=c.node,e=c.body;if(d.isInternal){var f=e.location.x,j=e.location.y;d.mass=d.mass+e.mass,d.massX=d.massX+e.mass*f,d.massY=d.massY+e.mass*j;var k=0,l=d.left,m=(d.right+l)/2,n=d.top,o=(d.bottom+n)/2;if(f>m){k+=1;var p=l;l=m,m+=m-p}if(j>o){k+=2;var q=n;n=o,o+=o-q}var r=d.quads[k];r||(r=g(),r.left=l,r.top=n,r.right=m,r.bottom=o,d.quads[k]=r),b.unshift({node:r,body:e})}else if(d.body){var s=d.body;d.body=null,d.isInternal=!0;if(i(s.location,e.location)){var t,u;do{var v=2*Math.random()*Math.PI,w=(d.right-d.left)*.006*Math.cos(v),x=(d.bottom-d.top)*.006*Math.sin(v);t=s.location.x+w,u=s.location.y+x}while(t<d.left||t>d.right||u<d.top||u>d.bottom);s.location.x=t,s.location.y=u}b.unshift({node:d,body:s}),b.unshift({node:d,body:e})}else d.body=e}},k=function(a){var d=[h],e,f,g,i;while(d.length){var j=d.shift(),k=j.body;k&&k!==a?(f=k.location.x-a.location.x,g=k.location.y-a.location.y,i=Math.sqrt(f*f+g*g),i===0&&(f=(Math.random()-.5)/50,g=(Math.random()-.5)/50,i=Math.sqrt(f*f+g*g)),e=b*k.mass*a.mass/(i*i*i),a.force.x=a.force.x+e*f,a.force.y=a.force.y+e*g):(f=j.massX/j.mass-a.location.x,g=j.massY/j.mass-a.location.y,i=Math.sqrt(f*f+g*g),i===0&&(f=(Math.random()-.5)/50,g=(Math.random()-.5)/50,i=Math.sqrt(f*f+g*g)),(j.right-j.left)/i<c?(e=b*j.mass*a.mass/(i*i*i),a.force.x=a.force.x+e*f,a.force.y=a.force.y+e*g):(j.quads[0]&&d.push(j.quads[0]),j.quads[1]&&d.push(j.quads[1]),j.quads[2]&&d.push(j.quads[2]),j.quads[3]&&d.push(j.quads[3])))}},l=function(a){var b=Number.MAX_VALUE,c=Number.MAX_VALUE,d=Number.MIN_VALUE,e=Number.MIN_VALUE,i,k=a.bodies,l=k.length;i=l;while(i--){var m=k[i].location.x,n=k[i].location.y;m<b&&(b=m),m>d&&(d=m),n<c&&(c=n),n>e&&(e=n)}var o=d-b,p=e-c;o>p?e=c+o:d=b+p,f=0,h=g(),h.left=b,h.right=d,h.top=c,h.bottom=e,i=l;while(i--)j(k[i],h)};return{insert:j,init:l,update:k,options:function(a){return a?(typeof a.gravity=="number"&&(b=a.gravity),typeof a.theta=="number"&&(c=a.theta),this):{gravity:b,theta:c}}}},Viva.Graph.Physics.nbodyForceBrute=function(a){a=a||{};var b=typeof a.gravity=="number"?a.gravity:-1,c=[],d=function(a){a.force.x=0,a.force.y=0;for(var d=0;d<c.length;++d){var e=c[d];if(e!==a){var f=e.location.x-a.location.x,g=e.location.y-a.location.y,h=Math.sqrt(f*f+g*g);h===0&&(f=(Math.random()-.5)/50,g=(Math.random()-.5)/50,h=Math.sqrt(f*f+g*g));var i=b*e.mass*a.mass/(h*h*h);a.force.x=a.force.x+i*f,a.force.y=a.force.y+i*g}}};return{insert:function(){},init:function(a){c=a.bodies},update:d,options:function(a){return a?(typeof a.gravity=="number"&&(b=a.gravity),this):{gravity:b}}}},Viva.Graph.Physics.dragForce=function(a){a=a||{};var b={coeff:a.coeff||.01};return{init:function(a){},update:function(a){a.force.x-=b.coeff*a.velocity.x,a.force.y-=b.coeff*a.velocity.y},options:function(a){return a?(typeof a.coeff=="number"&&(b.coeff=a.coeff),this):b}}},Viva.Graph.Physics.springForce=function(a){a=a||{};var b={length:a.length||50,coeff:typeof a.coeff=="number"?a.coeff:22e-5};return{init:function(a){},update:function(a){var c=a.body1,d=a.body2,e=a.length<0?b.length:a.length,f=d.location.x-c.location.x,g=d.location.y-c.location.y,h=Math.sqrt(f*f+g*g);h===0&&(f=(Math.random()-.5)/50,g=(Math.random()-.5)/50,h=Math.sqrt(f*f+g*g));var i=h-e,j=(!a.coeff||a.coeff<0?b.coeff:a.coeff)*i/h;c.force.x+=j*f,c.force.y+=j*g,d.force.x+=-j*f,d.force.y+=-j*g},options:function(a){return a?(typeof a.length=="number"&&(b.length=a.length),typeof a.coeff=="number"&&(b.coeff=a.coeff),this):b}}},Viva.Graph.Physics=Viva.Graph.Physics||{},Viva.Graph.Physics.forceSimulator=function(a){var b=a||Viva.Graph.Physics.rungeKuttaIntegrator(),c=[],d=[],e=[],f=[];return{speedLimit:1,bodies:c,accumulate:function(){var a,b,g;a=e.length;while(a--)e[a].init(this);a=f.length;while(a--)f[a].init(this);a=c.length;while(a--){g=c[a],g.force.x=0,g.force.y=0;for(b=0;b<e.length;b++)e[b].update(g)}for(a=0;a<d.length;++a)for(b=0;b<f.length;b++)f[b].update(d[a])},run:function(a){this.accumulate(),b.integrate(this,a)},addBody:function(a){if(!a)throw{message:"Cannot add null body to force simulator"};return c.push(a),a},removeBody:function(a){if(!a)return!1;var b=Viva.Graph.Utils.indexOfElementInArray(a,c);return b<0?!1:c.splice(b,1)},addSpring:function(a,b,c,e){if(!a||!b)throw{message:"Cannot add null spring to force simulator"};if(typeof c!="number")throw{message:"Spring length should be a number"};var f=new Viva.Graph.Physics.Spring(a,b,c,e>=0?e:-1);return d.push(f),f},removeSpring:function(a){if(!a)return!1;var b=Viva.Graph.Utils.indexOfElementInArray(a,d);return b<0?!1:d.splice(b,1)},addBodyForce:function(a){if(!a)throw{message:"Cannot add mighty (unknown) force to the simulator"};e.push(a)},addSpringForce:function(a){if(!a)throw{message:"Cannot add unknown force to the simulator"};f.push(a)}}},Viva.Graph.Layout=Viva.Graph.Layout||{},Viva.Graph.Layout.forceDirected=function(a,b){if(!a)throw{message:"Graph structure cannot be undefined"};b=b||{};var c={springLength:typeof b.springLength=="number"?b.springLength:80,springCoeff:typeof b.springCoeff=="number"?b.springCoeff:2e-4,gravity:typeof b.gravity=="number"?b.gravity:-1.2,theta:typeof b.theta=="number"?b.theta:.8,dragCoeff:typeof b.dragCoeff=="number"?b.dragCoeff:.02},d=Viva.Graph.Physics.forceSimulator(Viva.Graph.Physics.eulerIntegrator()),e=Viva.Graph.Physics.nbodyForce({gravity:c.gravity,theta:c.theta}),f=Viva.Graph.Physics.springForce({length:c.springLength,coeff:c.springCoeff}),g=Viva.Graph.Physics.dragForce({coeff:c.dragCoeff}),h=!0,i={x1:0,y1:0,x2:0,y2:0},j=function(a){return Math.floor(Math.random()*(a||4294967295))},k=function(b){var d=(i.x1+i.x2)/2,e=(i.y1+i.y2)/2,f=c.springLength;if(b.links&&b.links.length>0){var g=b.links[0],h=g.fromId!=b.id?a.getNode(g.fromId):a.getNode(g.toId);h.position&&(d=h.position.x,e=h.position.y)}return{x:d+j(f)-f/2,y:e+j(f)-f/2}},l=function(b){var c=b.force_directed_body;c||(b.position=b.position||k(b),c=new Viva.Graph.Physics.Body,c.mass=1+a.getLinks(b.id).length/3,b.force_directed_body=c,c.loc(b.position),d.addBody(c))},m=function(a){var b=a.force_directed_body;b&&(a.force_directed_body=null,delete a.force_directed_body,d.removeBody(b))},n=function(b){var c=a.getNode(b.fromId).force_directed_body,e=a.getNode(b.toId).force_directed_body;b.force_directed_spring=d.addSpring(c,e,-1)},o=function(a){var b=a.force_directed_spring;b&&(a.force_directed_spring=null,delete a.force_directed_spring,d.removeSpring(b))},p=function(){a.forEachNode(l),a.forEachLink(n)},q=function(a){return a?a.isPinned||a.data&&a.data.isPinned:!0},r=function(){var b=Number.MAX_VALUE,c=Number.MAX_VALUE,d=Number.MIN_VALUE,e=Number.MIN_VALUE;if(a.getNodesCount()===0)return;a.forEachNode(function(a){var f=a.force_directed_body;if(!f)return;q(a)&&f.loc(a.position),a.position.x=f.location.x,a.position.y=f.location.y,a.position.x<b&&(b=a.position.x),a.position.x>d&&(d=a.position.x),a.position.y<c&&(c=a.position.y),a.position.y>e&&(e=a.position.y)}),i.x1=b,i.x2=d,i.y1=c,i.y2=e};return d.addSpringForce(f),d.addBodyForce(e),d.addBodyForce(g),{run:function(a){a=a||50;for(var b=0;b<a;++b)this.step()},step:function(){h&&(p(),h=!1),d.run(20),r()},getGraphRect:function(){return i},addNode:function(a){l(a)},removeNode:function(a){m(a)},addLink:function(a){n(a)},removeLink:function(a){o(a)},springLength:function(a){return arguments.length===1?(f.options({length:a}),this):f.options().length},springCoeff:function(a){return arguments.length===1?(f.options({coeff:a}),this):f.options().coeff},gravity:function(a){return arguments.length===1?(e.options({gravity:a}),this):e.options().gravity},theta:function(a){return arguments.length===1?(e.options({theta:a}),this):e.options().theta},drag:function(a){return arguments.length===1?(g.options({coeff:a}),this):g.options().coeff}}},Viva.Graph.Layout=Viva.Graph.Layout||{},Viva.Graph.Layout.gem=function(a,b){if(!a)throw{message:"Graph structure cannot be undefined"};var c=function(a){var b={initialTemperature:a.initialTemperature||.3,stopTemperature:a.stopTemperature||.02,maxIterations:a.MaxIterations||5,edgeLength:a.springLength||80,gravitationalConstant:a.gravitationalConstant||.05,shakeDisturbance:a.shakeDisturbance||.2,oscilationSensitivity:a.oscilationSensitivity||.4,rotationSensitivity:a.rotationSensitivity||.9,minimalRotationTemperature:a.minimalRotationTemperature||2};return b.maximalTemperature=a.maximalTemperature||1.5*b.edgeLength,b.edgeLengthSquared=b.edgeLength*b.edgeLength,b.maxShakeOffset=b.shakeDisturbance*b.edgeLength,b}(b||{}),d,e,f,g={x1:0,y1:0,x2:0,y2:0},h=!0,i=function(a){return Math.floor(Math.random()*(a||4294967295))},j=function(b){var d=(g.x1+g.x2)/2,e=(g.y1+g.y2)/2,f=c.edgeLength;if(b.links&&b.links.length>0){var h=b.links[0],j=h.fromId!=b.id?a.getNode(h.fromId):a.getNode(h.toId);j.position&&(d=j.position.x,e=j.position.y)}return{x:d+i(f)-f/2,y:e+i(f)-f/2}},k=function(b){b.position=b.position||j(b),b.gemData={heat:c.initialTemperature*c.edgeLength,iX:0,iY:0,skewGauge:0,mass:1+a.getLinks(b.id).length/3},f+=b.gemData.heat*b.gemData.heat,d+=b.position.x,e+=b.position.y},l=function(a){a.gemData&&delete a.gemData},m=function(){f=0,d=0,e=0,a.forEachNode(k)},n=function(b){var f=b.position;if(!f)return;var g=c.edgeLengthSquared,h=f.x,j=f.y,k=b.gemData,l=a.getNodesCount(),m=(d/l-h)*k.mass*c.gravitationalConstant,n=(e/l-j)*k.mass*c.gravitationalConstant;return m+=i()%(2*c.maxShakeOffset+1)-c.maxShakeOffset,n+=i()%(2*c.maxShakeOffset+1)-c.maxShakeOffset,a.forEachNode(function(a){if(a.id!==b.id){var c=h-a.position.x,d=j-a.position.y,e=c*c+d*d;e>0&&(m+=c*g/e,n+=d*g/e)}}),a.forEachLinkedNode(b.id,function(a){var c=h-a.position.x,d=j-a.position.y,e=c*c+d*d;m-=c*e/(g*b.gemData.mass),n-=d*e/(g*b.gemData.mass)}),{iX:m,iY:n}},o=function(b,g){var h=g.iX,i=g.iY,j=a.getNodesCount();if(h===0&&i===0)return;var k=Math.max(Math.abs(h),Math.abs(i))/c.edgeLengthSquared;k>1&&(h/=k,i/=k);var l=b.gemData,m=Math.sqrt(h*h+i*i),n=l.heat;h=n*h/m,i=n*i/m,b.position.x+=h,b.position.y+=i,d+=h,e+=i;var o=n*Math.sqrt(l.iX*l.iX+l.iY*l.iY);o>0&&(f-=n*n,n+=n*c.oscilationSensitivity*(h*l.iX+i*l.iY)/o,n=Math.min(n,c.maximalTemperature),l.skewGauge+=c.rotationSensitivity*(h*l.iY-i*l.iX)/o,n-=n*Math.abs(l.skewGauge)/j,n=Math.max(n,c.minimalRotationTemperature),f+=n*n,l.heat=n),l.iX=h,l.iY=i};return{run:function(a){a=a||50;for(var b=0;b<a;++b)this.step()},step:function(){h&&(m(),h=!1);var b=a.getNodesCount(),d=c.stopTemperature*c.stopTemperature*c.edgeLengthSquared*b,e=c.maxIterations*b*b,i=Number.MAX_VALUE,j=Number.MAX_VALUE,k=Number.MIN_VALUE,l=Number.MIN_VALUE,p=this;if(f<d||b===0)return;a.forEachNode(function(a){if(p.isNodePinned(a)||!a.gemData)return;var b=n(a);o(a,b),a.position.x<i&&(i=a.position.x),a.position.x>k&&(k=a.position.x),a.position.y<j&&(j=a.position.y),a.position.y>l&&(l=a.position.y)}),g.x1=i,g.x2=k,g.y1=j,g.y2=l},isNodePinned:function(a){return a?a.isPinned||a.data&&a.data.isPinned:!0},getGraphRect:function(){return g},addNode:function(a){k(a)},removeNode:function(a){l(a)},addLink:function(a){},removeLink:function(a){}}},Viva.Graph.View=Viva.Graph.View||{},Viva.Graph.View.cssGraphics=function(){var a,b=function(){var a=Viva.BrowserInfo.browser,b="";switch(a){case"mozilla":b="Moz";break;case"webkit":b="webkit";break;case"opera":b="O";break;case"msie":var c=Viva.BrowserInfo.version.split(".")[0];if(c>8)b="ms";else return function(a,b,c,d){var e=Math.cos(d),f=Math.sin(d);d<0&&(d=2*Math.PI+d),d<Math.PI/2?(a.style.left=b+"px",a.style.top=c+"px"):d<Math.PI?(a.style.left=b-a.clientWidth*Math.cos(Math.PI-d),a.style.top=c):d<Math.PI+Math.PI/2?(a.style.left=b-a.clientWidth*Math.cos(Math.PI-d),a.style.top=c+a.clientWidth*Math.sin(Math.PI-d)):(a.style.left=b,a.style.top=c+a.clientWidth*Math.sin(Math.PI-d)),a.style.filter="progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand',M11="+e+", M12="+ -f+","+"M21="+f+", M22="+e+");"}}return b?function(a,c,d,e){a.style.left=c+"px",a.style.top=d+"px",a.style[b+"Transform"]="rotate("+e+"rad)",a.style[b+"TransformOrigin"]="left"}:function(a,b,c,d){}}(),c=function(a){var b=document.createElement("div");return b.setAttribute("class","node"),b},d=function(a,b){a.style.left=b.x-5+"px",a.style.top=b.y-5+"px"},e=function(a,c,d){var e=c.x-d.x,f=c.y-d.y,g=Math.sqrt(e*e+f*f);a.style.height="1px",a.style.width=g+"px",b(a,d.x,d.y,Math.atan2(f,e))},f=function(a){var b=document.createElement("div");return b.setAttribute("class","link"),b};return{node:function(a){return a&&typeof a!="function"?c(a):(c=a,this)},link:function(a){return a&&typeof a!="function"?f(a):(f=a,this)},placeNode:function(a){return d=a,this},placeLink:function(a){return e=a,this},init:function(b){a=b},initLink:function(b){a.childElementCount>0?a.insertBefore(b,a.firstChild):a.appendChild(b)},releaseLink:function(b){a.removeChild(b)},initNode:function(b){a.appendChild(b)},releaseNode:function(b){a.removeChild(b)},updateNodePosition:function(a,b){d(a,b)},updateLinkPosition:function(a,b,c){e(a,b,c)}}},Viva.Graph.svg=function(a){var b="http://www.w3.org/2000/svg",c="http://www.w3.org/1999/xlink",d=a;return typeof a=="string"&&(d=document.createElementNS(b,a)),d.vivagraph_augmented?d:(d.vivagraph_augmented=!0,d.attr=function(a,b){return arguments.length===2?(d.setAttributeNS(null,a,b),d):d.getAttributeNS(null,a)},d.append=function(a){var b=Viva.Graph.svg(a);return d.appendChild(b),b},d.text=function(a){return typeof a=="undefined"?d.textContent:(d.textContent=a,d)},d.link=function(a){return arguments.length===0?d.getAttributeNS(c,"xlink:href"):(d.setAttributeNS(c,"xlink:href",a),d)},d)},Viva.Graph.View=Viva.Graph.View||{},Viva.Graph.View.svgGraphics=function(){var a,b,c=function(a){return Viva.Graph.svg("rect").attr("width",10).attr("height",10).attr("fill","#00a2e8")},d=function(a,b){a.attr("x",b.x-5).attr("y",b.y-5)},e=function(a){return Viva.Graph.svg("line").attr("stroke","#999")},f=function(a,b,c){a.attr("x1",b.x).attr("y1",b.y).attr("x2",c.x).attr("y2",c.y)};return{node:function(a){return a&&typeof a!="function"?c(a):(c=a,this)},link:function(a){return a&&typeof a!="function"?e(a):(e=a,this)},placeNode:function(a){return d=a,this},placeLink:function(a){return f=a,this},init:function(c){b=Viva.Graph.svg("svg"),a=Viva.Graph.svg("g"),b.appendChild(a),c.appendChild(b)},initLink:function(b){a.childElementCount>0?a.insertBefore(b,a.firstChild):a.appendChild(b)},releaseLink:function(b){a.removeChild(b)},initNode:function(b){a.appendChild(b)},releaseNode:function(b){a.removeChild(b)},updateNodePosition:function(a,b){d(a,b)},updateLinkPosition:function(a,b,c){f(a,b,c)},getSvgRoot:function(){return b}}},Viva.Graph.View=Viva.Graph.View||{},Viva.Graph.View.renderer=function(a,b){var c=30;b=b||{};var d=b.layout,e=b.graphics,f=b.container,g,h=!1,i=!0,j=0,k=0,l={x:0,y:0},m={offsetX:0,offsetY:0},n=function(){f=f||document.body,d=d||Viva.Graph.Layout.forceDirected(a),e=e||Viva.Graph.View.svgGraphics(a,{container:f}),typeof b.renderLinks=="undefined"&&(b.renderLinks=!0),b.prerender=b.prerender||0},o=function(b){var c=a.getNode(b.fromId),d=a.getNode(b.toId);if(!c||!d)return;var f={x:Math.round(c.position.x+m.offsetX+l.x),y:Math.round(c.position.y+m.offsetY+l.y),node:c},g={x:Math.round(d.position.x+m.offsetX+l.x),y:Math.round(d.position.y+m.offsetY+l.y),node:d};e.updateLinkPosition(b.ui,f,g)},p=function(a){var b={x:Math.round(a.position.x+m.offsetX+l.x),y:Math.round(a.position.y+m.offsetY+l.y)};e.updateNodePosition(a.ui,b)},q=function(){b.renderLinks&&a.forEachLink(o),a.forEachNode(p)},r=function(){var a=d.step();return q(),!a},s=function(a){if(g){k+=a;return}a?(k+=a,g=Viva.Graph.Utils.timer(function(){j++,r();var a=j>=k;return a&&(g=null),!a},c)):(j=0,k=0,g=Viva.Graph.Utils.timer(r,c))},t=function(a){k>0&&s(a)},u=function(){if(typeof b.prerender=="number"&&b.prerender>0)for(var a=0;a<b.prerender;++a)d.step();else d.step()},v=function(){var a=d.getGraphRect(),b=Viva.Utils.getDimension(f);l.x=l.y=0,m.offsetX=b.width/2-(a.x2+a.x1)/2,m.offsetY=b.height/2-(a.y2+a.y1)/2,i=!1},w=function(a){var b=e.node(a);a.ui=b,e.initNode(b),a.position||d.addNode(a),p(a)},x=function(a){a.ui&&(e.releaseNode(a.ui),a.ui=null,delete a.ui),d.removeNode(a)},y=function(a){var b=e.link(a);a.ui=b,e.initLink(b),o(a)},z=function(a){a.ui&&(e.releaseLink(a.ui),a.ui=null,delete a.ui)},A=function(a){var b=!1;a.events=Viva.Graph.Utils.dragndrop(a.ui).onStart(function(){b=a.isPinned,a.isPinned=!0}).onDrag(function(b,c){a.position.x+=c.x,a.position.y+=c.y,t(2)}).onStop(function(){a.isPinned=b,t(100)})},B=function(a){a.events&&(a.events.release(),a.events=null,delete a.events)},C=function(){e.init(f),b.renderLinks&&a.forEachLink(y),a.forEachNode(w)},D=function(b){var c=b.node;b.changeType==="add"?(w(c),A(c),i&&v()):b.changeType==="remove"?(B(c),x(c),a.getNodesCount()===0&&(i=!0)):b.changeType!=="update"},E=function(a){var c=a.link;a.changeType==="add"?(b.renderLinks&&y(c),d.addLink(c)):a.changeType==="remove"?(b.renderLinks&&z(c),d.removeLink(c)):a.changeType!=="update"},F=function(){Viva.Graph.Utils.events(window).on("resize",function(){v(),r()});var b=Viva.Graph.Utils.dragndrop(f);b.onDrag(function(a,b){l.x+=b.x,l.y+=b.y,q()}),a.forEachNode(A),Viva.Graph.Utils.events(a).on("changed",function(a){for(var b=0;b<a.length;++b){var c=a[b];c.node?D(c):c.link&&E(c)}t(100)})};return{run:function(a){return h||(n(),u(),v(),C(),F(),h=!0),s(a),this}}},Viva.Graph.serializer=function(){var a=function(){if(typeof JSON=="undefined"||!JSON.stringify||!JSON.parse)throw"JSON serializer is not defined."};return{storeToJSON:function(b){if(!b)throw"Graph is not defined";a();var c={nodes:[],links:[]};return b.forEachNode(function(a){c.nodes.push({id:a.id,data:a.data})}),b.forEachLink(function(a){c.links.push({fromId:a.fromId,toId:a.toId,data:a.data})}),JSON.stringify(c)},loadFromJSON:function(b){if(typeof b!="string")throw"String expected in loadFromJSON() metho";a();var c=JSON.parse(b),d=Viva.Graph.graph();if(!c||!c.nodes||!c.links)throw"Passed json string does not represent valid graph";for(var e=0;e<c.nodes.length;++e){var f=c.nodes[e];if(!f.id)throw"Graph node format is invalid. Node.id is missing";d.addNode(f.id,f.data)}for(e=0;e<c.links.length;++e){var g=c.links[e];if(!g.fromId||!g.toId)throw"Graph link format is invalid. Both fromId and toId are required";d.addLink(g.fromId,g.toId,g.data)}return d}}}